C51 COMPILER V9.52.0.0   UART                                                              01/28/2016 14:49:20 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN UART.OBJ
COMPILER INVOKED BY: D:\learn\Learning software\keil4\C51\BIN\C51.EXE UART.C BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          
   2          /*******************************************************************************
   3          * 文件名 : UART.C
   4          
   5          * 版本     作者            日期            说明
   6          * V1.0     NJH        2015/08/03       初始版本
   7          
   8          * 描述   : MCU:      晶振:    MHz
   9                     
  10          *******************************************************************************/
  11          
  12          #include "uart.h"
  13          #include <reg52.H>
  14          
  15          
  16          /*******************************************************************************
  17          * 功能描述 : 51单片机的串口初始化
  18          * 函数属性 : 外部
  19          * 输入参数 : 无
  20          * 返回参数 : 无
  21          * 函数详解 : 
  22                
  23          *******************************************************************************/
  24          
  25          void UartInit(void)   //115200bps@22.1184MHz
  26          {
  27   1        TMOD |=0x20;   //设置定时器T/C1工作在方式2,定时1工作于自动重载模式
  28   1        SCON=0x50;     //设置串行口工作方式1：SCON格式 |M0|M1|M2|REN|TB8|RB8|TI|RI
  29   1        TH1=0xfd;      //波特率9600
  30   1        TL1=0xfd;
  31   1        ET1 = 0;    //禁止定时器1中断
  32   1        TR1 = 1;    //启动定时器1
  33   1        UART_Send_Str("串口初始化完毕!\n");
  34   1      }
  35          
  36          /*******************************************************************************
  37          * 功能描述 : 51单片机的串口中断处理函数
  38          * 函数属性 : 外部
  39          * 输入参数 : 无
  40          * 返回参数 : 无
  41          * 函数详解 : 
  42                
  43          *******************************************************************************/
  44          
  45          void UART_inter() interrupt 4    //串口中断函数
  46          {
  47   1          ES=0;
  48   1          //串口中断处理
  49   1          /*
  50   1          if(RI)
  51   1          {
  52   1          if(SBUF!=0x08)  //如果接收到的是退格(ASCII码为0x08)
  53   1          cmd_buf[counter++]=SBUF;
  54   1          else
  55   1          counter--;
C51 COMPILER V9.52.0.0   UART                                                              01/28/2016 14:49:20 PAGE 2   

  56   1          RI=0;
  57   1          }
  58   1          if(SBUF==0x0d)
  59   1          {
  60   1          cmd_buf[counter-1]=0;
  61   1          counter=0;
  62   1          flag=1;
  63   1          }
  64   1          */
  65   1          ES=1;
  66   1      }
  67          
  68          /*******************************************************************************
  69          * 功能描述 : 51单片机的串口发送一个字节的函数
  70          * 函数属性 : 外部
  71          * 输入参数 : unsigned char mydata,要发送的一个字节内容
  72          * 返回参数 : 无
  73          * 函数详解 : 
  74                
  75          *******************************************************************************/
  76          
  77          void UART_Send_Byte(unsigned char mydata) 
  78          {
  79   1          ES=0;
  80   1          TI=0;
  81   1          SBUF=mydata;
  82   1          while(!TI);
  83   1          TI=0;
  84   1          ES=1;
  85   1      }
  86           
  87          /*******************************************************************************
  88          * 功能描述 : 串口发送0d和0a两个字节,即回车换行,在串口助手上有回车换行的效果
  89          * 函数属性 : 外部
  90          * 输入参数 : 无
  91          * 返回参数 : 无
  92          * 函数详解 : 
  93                
  94          *******************************************************************************/
  95          
  96          void UART_Send_Enter()
  97          {
  98   1          UART_Send_Byte(0x0d);  
  99   1          UART_Send_Byte(0x0a);  
 100   1      }
 101          
 102          /*******************************************************************************
 103          * 功能描述 : 单片机的串口发送字符串
 104          * 函数属性 : 外部
 105          * 输入参数 : char *s ,指向字符串的指针
 106          * 返回参数 : 无
 107          * 函数详解 : 
 108                
 109          *******************************************************************************/
 110          
 111          void UART_Send_Str(char *s)
 112          {
 113   1          int idata len=strlen(s)-1;
 114   1          int idata i;
 115   1      
 116   1          for(i=0;i<len;i++)
 117   1          {
C51 COMPILER V9.52.0.0   UART                                                              01/28/2016 14:49:20 PAGE 3   

 118   2              UART_Send_Byte(s[i]);
 119   2          }
 120   1          
 121   1          if(s[i]=='\n') 
 122   1          {
 123   2              UART_Send_Enter();
 124   2          }
 125   1          else
 126   1          {
 127   2              UART_Send_Byte(s[i]);
 128   2          }
 129   1      }
 130          
 131          /*******************************************************************************
 132          * 功能描述 : 串口发送数值,函数会将数值转为相应的字符串,如 45 转为 "45"再发送出去
 133          * 函数属性 : 外部
 134          * 输入参数 : unsigned long dat,要发送的数值
 135          * 返回参数 : 无
 136          * 函数详解 : 
 137                
 138          *******************************************************************************/
 139          
 140          void UART_Put_Num(unsigned long dat)
 141          {
 142   1          char idata temp[20];
 143   1          u32_to_str(dat,temp); //把数值转为字符
 144   1          UART_Send_Str(temp);
 145   1        UART_Send_Enter();
 146   1      }
 147          
 148          /*******************************************************************************
 149          * 功能描述 : 单片机的串口发送调试信息
 150          * 函数属性 : 外部
 151          * 输入参数 : inf:指向提示信息字符串的指针,dat:数值,提示信息就是这个数值的描述
 152          * 返回参数 : 无
 153          * 函数详解 :  
 154                
 155          *******************************************************************************/
 156          
 157          void UART_Put_Inf(char *inf,unsigned long dat)
 158          {
 159   1          UART_Send_Str(inf);     //输出的提示信息,用来描述数值
 160   1          UART_Put_Num(dat);      //输出数值
 161   1          UART_Send_Str("\n");    //换行
 162   1      }
 163          
 164          /*******************************************************************************
 165          * 功能描述 : 将一个32位的变量dat转为字符串，比如把1234转为"1234"
 166          * 函数属性 : 外部
 167          * 输入参数 : dat:待转换的变量,str:指向字符数组的指针，转换后的字节串放在其中
 168          * 返回参数 : 无
 169          * 函数详解 : 
 170                
 171          *******************************************************************************/
 172          
 173          void u32_to_str(unsigned long dat,char *str) 
 174          {
 175   1          char idata temp[20];
 176   1          unsigned char idata i=0,j=0;
 177   1      
 178   1          i=0;
 179   1          while(dat)
C51 COMPILER V9.52.0.0   UART                                                              01/28/2016 14:49:20 PAGE 4   

 180   1          {
 181   2              temp[i]=dat%10+0x30;
 182   2              i++;
 183   2              dat/=10;
 184   2          }
 185   1          
 186   1          j=i;
 187   1          for(i=0;i<j;i++)
 188   1          {
 189   2              str[i]=temp[j-i-1];
 190   2          }
 191   1          
 192   1          if(!i) {str[i++]='0';}
 193   1          str[i]=0;
 194   1      }
 195          
 196          /*******************************************************************************
 197          * 功能描述 : 将一个字符串转为32位的变量，比如"1234"转为1234
 198          * 函数属性 : 外部
 199          * 输入参数 : char *str,指向待转换的字符串的指针
 200          * 返回参数 : unsigned long temp ,转换后的数值
 201          * 函数详解 : 
 202                
 203          *******************************************************************************/
 204          
 205          //unsigned long str_to_u32(char *str) 
 206          //{
 207          //    unsigned long idata temp=0;
 208          //    unsigned long idata fact=1;
 209          //    unsigned char idata len=strlen(str);
 210          //    unsigned char idata i;
 211          
 212          //    for(i=len;i>0;i--)
 213          //    {
 214          //        temp += ((str[i-1]-0x30)*fact);
 215          //        fact *= 10;
 216          //    }
 217          //    return temp;
 218          //}
 219          
 220          
 221          /*******************************************************************************
 222          * 功能描述 : 将数值转换为字符串,如 15 转为 "000F"
 223          * 函数属性 : 外部
 224          * 输入参数 : hex 要转换的数值, str 指向用来保存结果的数组的指针
 225          * 返回参数 : unsigned char 0 
 226          * 函数详解 : 
 227                
 228          *******************************************************************************/
 229          
 230          
 231          unsigned char Hex2Str_16b(unsigned int hex,char *str)
 232          {
 233   1          unsigned char temp=0;
 234   1      
 235   1          temp=((hex&0xf000)>>12);
 236   1          str[0]=(temp>=10)?(temp-10+'A'):(temp+0x30);
 237   1      
 238   1          temp=((hex&0x0f00)>>8);
 239   1          str[1]=(temp>=10)?(temp-10+'A'):(temp+0x30);
 240   1      
 241   1          temp=((hex&0x00f0)>>4);
C51 COMPILER V9.52.0.0   UART                                                              01/28/2016 14:49:20 PAGE 5   

 242   1          str[2]=(temp>=10)?(temp-10+'A'):(temp+0x30);
 243   1      
 244   1          temp=((hex&0x000f)>>0);
 245   1          str[3]=(temp>=10)?(temp-10+'A'):(temp+0x30);
 246   1      
 247   1          str[4]=0;
 248   1      
 249   1          return 0;
 250   1      }
 251          
 252          /*******************************************************************************
 253          * 功能描述 : 将数值以16进制输出到串口,能显示的最大值为 65535
 254          * 函数属性 : 外部
 255          * 输入参数 : 要输出显示的数值
 256          * 返回参数 : 无
 257          * 函数详解 : 
 258                
 259          *******************************************************************************/
 260          
 261          
 262          void UART_Put_Hex(unsigned int hex)
 263          {
 264   1          char temp[20];
 265   1          Hex2Str_16b(hex,temp);
 266   1          UART_Send_Str(temp);
 267   1      }
 268          
 269          //void main()
 270          //{
 271          //  unsigned char i = 7 ;
 272          //  UartInit();       //串口初始化
 273          //  UART_Send_Str("hello\n"); //发送字符串
 274          //  UART_Put_Num(i);    //以10进制形式显示数值大小
 275          //  UART_Send_Enter();      //回车换行
 276          //  UART_Put_Hex(15); //以16进制形式显示数值大小
 277          //  UART_Send_Enter();      //回车换行
 278          //  UART_Put_Inf("i= ",i);  // 本语句在这里的输出结果为  i=7
 279          //  UART_Send_Byte(48);   //输出一个48,48对应的ascll码字符为'0',所以本语句显示内容为  0
 280          //  while(1);
 281          //}


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    527    ----
   CONSTANT SIZE    =     19    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      34
   IDATA SIZE       =   ----      46
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
