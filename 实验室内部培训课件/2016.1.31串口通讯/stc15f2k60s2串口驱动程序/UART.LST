C51 COMPILER V9.01   UART                                                                  01/28/2016 14:47:53 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN UART.OBJ
COMPILER INVOKED BY: D:\软件安装目录\keil4安装目录\C51\BIN\C51.EXE UART.C BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*******************************************************************************
   2          *文件名     : uart.c
   3          *作用       : 串口中断程序
   4          *原理       : 无
   5          ********************************************************************************
   6          *版本     作者            日期            说明
   7          *V0.1     Njh           2015/7/25     初始版本
   8          ********************************************************************************/
   9          
  10          #include "uart.h"
  11          
  12          
  13          unsigned char counter;
  14          
  15          
  16          /*******************************************************************************
  17          * 功能描述 : 51单片机的串口初始化
  18          * 函数属性 : 外部
  19          * 输入参数 : 无
  20          * 返回参数 : 无
  21          * 函数详解 : 
  22                
  23          *******************************************************************************/
  24          
  25          void UartInit(void)             //22.1184MHz
  26          {
  27   1                      SCON = 0x50;            //8位数据,可变波特率
  28   1                      AUXR |= 0x40;           //定时器1时钟为Fosc,即1T
  29   1                      AUXR &= 0xFE;           //串口1选择定时器1为波特率发生器
  30   1                      TMOD &= 0x0F;           //设定定时器1为16位自动重装方式
  31   1                      TL1 = 0xD0;             //设定定时初值
  32   1                      TH1 = 0xFF;             //设定定时初值
  33   1                      ET1 = 0;                //禁止定时器1中断
  34   1                      TR1 = 1;                //启动定时器1
  35   1                      
  36   1                      EA = 1;
  37   1                      ES  = 1;        //打开接收中断
  38   1                      
  39   1                      UART_Send_Str("1  串口初始化完毕!\n");
  40   1                       
  41   1                      UART_Put_Inf ("2  已启用热启动（自动下载），请注意程序是否异常\n",3);
  42   1                      
  43   1                      UART_Send_Str("   下面将测试Printf( )函数,请注意提示！！！\n");
  44   1                      printf       ("   printf( ) is ok!\n\n");       
  45   1      }
  46          
  47          /*******************************************************************************
  48          * 功能描述 : 51单片机的串口中断处理函数
  49          * 函数属性 : 外部
  50          * 输入参数 : 无
  51          * 返回参数 : 无
  52          * 函数详解 : 
  53                
  54          *******************************************************************************/
  55          
C51 COMPILER V9.01   UART                                                                  01/28/2016 14:47:53 PAGE 2   

  56          void UART_inter() interrupt 4    //串口中断函数
  57          {
  58   1              ES=0;
  59   1          //中断接收处理
  60   1          if(RI)
  61   1          {
  62   2                      RI=0;
  63   2      //              UART_buf[counter++] = SBUF;
  64   2      //              if(counter == 4){counter = 0;}
  65   2                      IAP_CONTR = 0X60;  //STC15软件复位进入ISP下载
  66   2          }
  67   1       
  68   1          ES=1;  
  69   1      }
  70          
  71          /*******************************************************************************
  72          * 功能描述 : 51单片机的串口发送一个字节的函数
  73          * 函数属性 : 外部
  74          * 输入参数 : unsigned char mydata,要发送的一个字节内容
  75          * 返回参数 : 无
  76          * 函数详解 : 
  77                
  78          *******************************************************************************/
  79          
  80          void UART_Send_Byte(unsigned char mydata)       
  81          {
  82   1          ES=0;
  83   1          TI=0;
  84   1          SBUF=mydata;
  85   1          while(!TI);
  86   1          TI=0;
  87   1          ES=1;
  88   1      }
  89           
  90          /*******************************************************************************
  91          * 功能描述 : 串口发送0d和0a两个字节,即回车换行,在串口助手上有回车换行的效果
  92          * 函数属性 : 外部
  93          * 输入参数 : 无
  94          * 返回参数 : 无
  95          * 函数详解 : 
  96                
  97          *******************************************************************************/
  98          
  99          void UART_Send_Enter()
 100          {
 101   1          UART_Send_Byte(0x0d);  
 102   1          UART_Send_Byte(0x0a);  
 103   1      }
 104          
 105          /*******************************************************************************
 106          * 功能描述 : 单片机的串口发送字符串
 107          * 函数属性 : 外部
 108          * 输入参数 : char *s ,指向字符串的指针
 109          * 返回参数 : 无
 110          * 函数详解 : 
 111                
 112          *******************************************************************************/
 113          
 114          void UART_Send_Str(char *s)
 115          {
 116   1          int idata len=strlen(s)-1;
 117   1          int idata i;
C51 COMPILER V9.01   UART                                                                  01/28/2016 14:47:53 PAGE 3   

 118   1      
 119   1          for(i=0;i<len;i++)
 120   1          {
 121   2              UART_Send_Byte(s[i]);
 122   2          }
 123   1          
 124   1          if(s[i]=='\n') 
 125   1          {
 126   2              UART_Send_Enter();
 127   2          }
 128   1          else
 129   1          {
 130   2              UART_Send_Byte(s[i]);
 131   2          }
 132   1      }
 133          
 134          /*******************************************************************************
 135          * 功能描述 : 串口发送数值,函数会将数值转为相应的字符串,如 45 转为 "45"再发送出去
 136          * 函数属性 : 外部
 137          * 输入参数 : unsigned long dat,要发送的数值
 138          * 返回参数 : 无
 139          * 函数详解 : 
 140                
 141          *******************************************************************************/
 142          
 143          void UART_Put_Num(unsigned long dat)
 144          {
 145   1          char idata temp[20];
 146   1          u32_to_str(dat,temp); //把数值转为字符
 147   1          UART_Send_Str(temp);
 148   1      }
 149          
 150          /*******************************************************************************
 151          * 功能描述 : 单片机的串口发送调试信息
 152          * 函数属性 : 外部
 153          * 输入参数 : inf:指向提示信息字符串的指针,dat:数值,提示信息就是这个数值的描述
 154          * 返回参数 : 无
 155          * 函数详解 :  
 156                
 157          *******************************************************************************/
 158          
 159          void UART_Put_Inf(char *inf,unsigned long dat)
 160          {
 161   1          UART_Send_Str(inf);     //输出的提示信息,用来描述数值
 162   1          UART_Put_Num(dat);      //输出数值
 163   1          UART_Send_Str("\n");    //换行
 164   1      }
 165          
 166          /*******************************************************************************
 167          * 功能描述 : 将一个32位的变量dat转为字符串，比如把1234转为"1234"
 168          * 函数属性 : 外部
 169          * 输入参数 : dat:待转换的变量,str:指向字符数组的指针，转换后的字节串放在其中
 170          * 返回参数 : 无
 171          * 函数详解 : 
 172                
 173          *******************************************************************************/
 174          
 175          void u32_to_str(unsigned long dat,char *str) 
 176          {
 177   1          char idata temp[20];
 178   1          unsigned char idata i=0,j=0;
 179   1      
C51 COMPILER V9.01   UART                                                                  01/28/2016 14:47:53 PAGE 4   

 180   1          i=0;
 181   1          while(dat)
 182   1          {
 183   2              temp[i]=dat%10+0x30;
 184   2              i++;
 185   2              dat/=10;
 186   2          }
 187   1          
 188   1          j=i;
 189   1          for(i=0;i<j;i++)
 190   1          {
 191   2              str[i]=temp[j-i-1];
 192   2          }
 193   1          
 194   1          if(!i) {str[i++]='0';}
 195   1          str[i]=0;
 196   1      }
 197          
 198          
 199          
 200          /*******************************************************************************
 201          * 功能描述  : 重定向这个C库（stdio）printf函数  文件流――》串口USART1
 202          * 函数属性  : 内部
 203          * 输入参数  : ch,*f
 204          * 返回参数  : 无
 205          * 函数详解  : 
 206          
 207          *******************************************************************************/
 208          
 209          char putchar(char c)
 210          {
 211   1              if (c == '\n')              //判断换行符'\n'，若是换行符，需要插入回车符'\r'
 212   1              {
 213   2                      ES = 0;                 //关闭串口中断
 214   2                      SBUF = '\r';            //发送回车符
 215   2                      while(!TI);                 //因为串口速度较慢，等待发送完成
 216   2                      TI = 0;                 //清除发送标记
 217   2                      ES = 1;                 //发送完毕，开启串口中断，以响应串口接收
 218   2              }
 219   1      
 220   1              ES = 0;                     //关闭串口中断
 221   1              SBUF = c;                   //发送printf传递过来的字符
 222   1              while(!TI);
 223   1              TI = 0;
 224   1              ES = 1;
 225   1              return(1);               //必须要返回true
 226   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    468    ----
   CONSTANT SIZE    =    137    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1      14
   IDATA SIZE       =   ----      46
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
